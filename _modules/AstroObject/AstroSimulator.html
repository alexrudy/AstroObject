

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>AstroObject.AstroSimulator &mdash; AstroObject 0.5-b1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.5-b1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="AstroObject 0.5-b1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">AstroObject 0.5-b1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for AstroObject.AstroSimulator</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># </span>
<span class="c">#  AstroSimulator.py</span>
<span class="c">#  AstroObject</span>
<span class="c">#  </span>
<span class="c">#  Created by Alexander Rudy on 2011-12-14.</span>
<span class="c">#  Copyright 2011 Alexander Rudy. All rights reserved.</span>
<span class="c">#  Version 0.5-b1</span>
<span class="c"># </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:mod:`AstroSimulator` — Complex Task Management </span>
<span class="sd">===============================================</span>

<span class="sd">The Simulator is designed to provide a high level, command-line useful interface to large computational tasks. As the name suggests, Simulators often do a lot of programming work, and do so across many distinct &quot;stages&quot;, whcih can be configured in any way the user desires. All of the abilities in this program are simply object abstraction techniques to provide a complex program with a command line interface and better control and reporting on the activities carreid out to successfully complete the program. It allows for the configuration of simple test cases and &quot;macros&quot; from within the program, eliminating the need to provide small wrapper scripts and test handlers.</span>

<span class="sd">An example (simple) program using the simulator can be found in :ref:`SimulatorExample`</span>

<span class="sd">.. _Simulator_CLI:</span>

<span class="sd">:program:`Simulator` Command Line Interface</span>
<span class="sd">-------------------------------------------</span>

<span class="sd">The master simulator program is a command-line interface to the :meth:`AstroObject.AstroSimulator.Simulator.run` method. Below are the major command line components.</span>

<span class="sd">Usage Statement ::</span>
<span class="sd">	</span>
<span class="sd">	Simulator [ options ][ configuration ] {stages}</span>
<span class="sd">	</span>
<span class="sd">The program is actually agnostic to the order of arguments. Any argument may come in any position. As such, all arguments must be unique.</span>

<span class="sd">.. program:: Simulator</span>

<span class="sd">.. option:: {stages}</span>
<span class="sd">	</span>
<span class="sd">	The stages option specifies individual stages for the program to run. You must specify at least one stage to run in the simulator. By default, two basic stages are provided, ``*all`` and ``*none``. The default simulation is performed by ``*all``. To test the simulator without running any stages (for example, to test :meth:`AstroObject.AstroSimulator.Simulator.registerFunction` functionality), use the ``*none`` stage to opertate without using any stages.</span>
<span class="sd">	</span>
<span class="sd">	Stages are called with either a ``*``, ``+`` or ``-`` character at the beginning. Their resepctive actions are shown below. All commands must include at least one macro. If you don&#39;t want any particular macro, use the ``*none`` macro.</span>
<span class="sd">	</span>
<span class="sd">	To run a simulation using the ``*all`` macro, the command would be::</span>
<span class="sd">		</span>
<span class="sd">		$ Simulator *all</span>
<span class="sd">		</span>
<span class="sd">	</span>
<span class="sd">	</span>
<span class="sd">	========= ============ ================================</span>
<span class="sd">	Character  Action      Description</span>
<span class="sd">	========= ============ ================================</span>
<span class="sd">	``*``     Include      To include a stage, use ``*stage``. This will also run the dependents for that stage.</span>
<span class="sd">	``-``     Exclude      To exclude a stage, use ``-stage``. This stage (and it&#39;s dependents) will be skipped.</span>
<span class="sd">	``+``     Include-only To include a stage, but not the dependents of that stage, use ``+stage``.</span>
<span class="sd">	========= ============ ================================</span>
<span class="sd">	</span>
<span class="sd">	.. Note ::</span>
<span class="sd">		Including an argument and excluding it simultaneously will have the effect of including it overall. So the following three commands are equivalent::</span>
<span class="sd">			</span>
<span class="sd">			$ Simulator +stage -stage *none</span>
<span class="sd">			$ Simulator -stage +stage *none</span>
<span class="sd">			$ Simulator +stage *none</span>
<span class="sd">			</span>
<span class="sd">		Also, excluding a stage that is included as a macro will exclude that stage and not call it&#39;s dependents, so the following calls are equivalent ::</span>
<span class="sd">			</span>
<span class="sd">			$ Simulator -stage *stage</span>
<span class="sd">			$ Simulator *none</span>

<span class="sd">	</span>
<span class="sd">	The commonly used stages in :program:`Simulator` are</span>
<span class="sd">	</span>
<span class="sd">	=====================  ========================================</span>
<span class="sd">	  Stage                Description                             </span>
<span class="sd">	=====================  ========================================</span>
<span class="sd">	  ``*all``              Run all default stages                 </span>
<span class="sd">	  ``*none``             Run no stages                          </span>
<span class="sd">	=====================  ========================================</span>
<span class="sd">	</span>
<span class="sd">	Stages are registered by the :meth:`AstroObject.AstroSimulator.Simulator.registerStage` method.</span>
<span class="sd">	</span>
<span class="sd">.. option:: [configurations]</span>
<span class="sd">	</span>
<span class="sd">	Configuration options override defaults set up in :class:`AstroObject.AstroSimulator.Simulator`. As such, they are useful quick changes to a configuration.</span>
<span class="sd">	</span>
<span class="sd">	 ===================== ============================================</span>
<span class="sd">	   Options               Description</span>
<span class="sd">	 ===================== ============================================</span>
<span class="sd">	   ``-d``                enable debugging messages and plots</span>
<span class="sd">	 ===================== ============================================</span>
<span class="sd">	</span>
<span class="sd">	.. Note::</span>
<span class="sd">		This means if you dump the configuration file (see :option:`--dump`) and use that directly as your new configuration file, these options will have no effect. Therefore, it is advisable that your configuration file contain the minimum amount of detail to override the default values set in the program. However, if you wish to use these options, but always disable debug, for example, you could disable debug in your configuration file. This will make none of these flags enable debugging.</span>
<span class="sd">		</span>
<span class="sd">	</span>
<span class="sd">.. option:: -h, --help</span>
<span class="sd">	</span>
<span class="sd">	Get help about the :program:`Simulator` command. Help will list commonly used stages, optional arguments, and configuration items.</span>
<span class="sd">	</span>
<span class="sd">	.. Note ::</span>
<span class="sd">		To get a full list of stages available, use :option:`--stages`</span>
<span class="sd">		</span>
<span class="sd">.. option:: --version</span>
<span class="sd">	</span>
<span class="sd">	Print the program version.</span>
<span class="sd">	</span>
<span class="sd">.. option:: --cf file.yaml</span>
<span class="sd">	</span>
<span class="sd">	Set the name of the configuration file to use. By default, the configuation file is called `SED.main.config.yaml`. This will be the filename used for dumping configurations with the :option:`--dump` command (Dump will append the extension ``-dump.yaml`` onto the filename to prevent overwriting exisitng configurations)</span>
<span class="sd">	</span>
<span class="sd">.. option:: --dry-run</span>
<span class="sd">	</span>
<span class="sd">	Traverse all of the stages to be run, printing them as the program goes, but do not run any stages.</span>
<span class="sd">	</span>
<span class="sd">.. option:: --stages</span>
<span class="sd">	</span>
<span class="sd">	Print all stages registered in the simulator. Any stage listed in the output of this function can be run.</span>
<span class="sd">	</span>
<span class="sd">.. option:: --dump</span>
<span class="sd">	</span>
<span class="sd">	Dump the configuration to a file. Filenames are the configuration file name with ``-dump.yaml`` appended.</span>

<span class="sd">.. option:: --profile</span>
<span class="sd">    </span>
<span class="sd">    Show a timing profile of the simulation, including status of stages, at the end of the simulation.</span>

<span class="sd">.. _Configuration:</span>

<span class="sd">:program:`Simulator` Configuration Files</span>
<span class="sd">----------------------------------------</span>

<span class="sd">:program:`Simulator` configuration files are YAML files which contain a dictionary structure. All values in the YAML files are basic yaml, and contain no python-specific directives. To find out what the default or current configuration is, use the :option:`--dump` command. The file produced from this will contain a YAML structure for the configuration in use when the system started up. The various directives in the configuration file are described below.</span>

<span class="sd">- ``Configurations``: contains a list of potential configuration files.</span>
<span class="sd">    - ``Main``: The name of the primary configuration file. This default is produced by the program. Overriding it in the configuration file has essentially no effect.</span>
<span class="sd">- ``Dirs``: Directories that this simulator will use for output.</span>
<span class="sd">    - ``Caches``: Location of cache files.</span>
<span class="sd">        .. Note:: This function has almost no effect, but can be used internally by the simulator. See :ref:`SimulatorExample`</span>
<span class="sd">    - ``Logs``: Location of log files</span>
<span class="sd">    - ``Partials``: Location of partial output, including a dump of the configuration.</span>
<span class="sd">- ``Logging``: Configuration of the :mod:`AstroObject.AstroObjectLogging` module</span>

<span class="sd">A simple configuration file can be found in the :ref:`SimulatorExample`.</span>

<span class="sd">.. _Simulator_API:</span>

<span class="sd">API Methods</span>
<span class="sd">-----------</span>
<span class="sd">    </span>
<span class="sd">The following methods handle the external-API for the simulator. Normally, when you write a simulator, you will subclass the :class:`Simulator`, and then use the methods here to control the behavior of the simulator. At a minimum, a simulator must register stages, probably using :meth:`Simulator.collect` or :meth:`Simulator.registerStage`, and then call the :meth:`Simulator.run` function to process the command line interface and start the simulator.</span>
<span class="sd">    </span>
<span class="sd">.. autoclass::</span>
<span class="sd">    AstroObject.AstroSimulator.Simulator</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: collect</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: registerStage</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: registerConfigOpts</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: registerFunction</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: run</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: startup</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: do</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: exit</span>
<span class="sd">    </span>
<span class="sd">    .. automethod:: map_over_collection</span>

<span class="sd">.. _Simulator_Decorators:</span>
<span class="sd">    </span>
<span class="sd">Decorators</span>
<span class="sd">----------</span>
<span class="sd">The following decorators can be used (in conjuction with :meth:`AstroObject.AstroSimulator.Simulator.collect`) to register and configure simulator stages:</span>

<span class="sd">.. autofunction:: collect</span>

<span class="sd">.. autofunction:: ignore</span>

<span class="sd">.. autofunction:: include</span>

<span class="sd">.. autofunction:: help</span>

<span class="sd">.. autofunction:: description</span>

<span class="sd">.. autofunction:: depends</span>

<span class="sd">.. autofunction:: replaces</span>

<span class="sd">.. autofunction:: optional</span>
<span class="sd">    </span>
<span class="sd">Private Methods and Classes</span>
<span class="sd">---------------------------</span>
<span class="sd">    </span>
<span class="sd">These methods are used to implment the public-facing API. They are documented here to explain their use in development.</span>

<span class="sd">.. inheritance-diagram::</span>
<span class="sd">    AstroObject.AstroSimulator.Simulator</span>
<span class="sd">    AstroObject.AstroSimulator.Stage</span>
<span class="sd">    :parts: 1</span>

<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator._initOptions</span>

<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator._default_macros</span>
<span class="sd">    </span>
<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator._parseArguments</span>
<span class="sd">    </span>
<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator._preConfiguration</span>
<span class="sd">    </span>
<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator._configure</span>
<span class="sd">    </span>
<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator._postConfiguration</span>

<span class="sd">.. automethod:: </span>
<span class="sd">    AstroObject.AstroSimulator.Simulator.execute</span>
<span class="sd">    </span>
<span class="sd">.. autoclass::</span>
<span class="sd">    AstroObject.AstroSimulator.Stage</span>


<span class="sd">&quot;&quot;&quot;</span>


<span class="c"># Standard Python Modules</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="c"># Dependent Modules</span>
<span class="kn">from</span> <span class="nn">progressbar</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Submodules from this system</span>
<span class="kn">from</span> <span class="nn">AstroCache</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroConfig</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Utilities</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Simulator&quot;</span><span class="p">,</span><span class="s">&quot;on_collection&quot;</span><span class="p">,</span><span class="s">&quot;help&quot;</span><span class="p">,</span><span class="s">&quot;replaces&quot;</span><span class="p">,</span><span class="s">&quot;excepts&quot;</span><span class="p">,</span><span class="s">&quot;depends&quot;</span><span class="p">,</span><span class="s">&quot;include&quot;</span><span class="p">,</span><span class="s">&quot;optional&quot;</span><span class="p">,</span><span class="s">&quot;description&quot;</span><span class="p">,</span><span class="s">&quot;collect&quot;</span><span class="p">,</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span><span class="s">&quot;on_instance_collection&quot;</span><span class="p">]</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="n">getVersion</span><span class="p">()</span>

<div class="viewcode-block" id="Stage"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Stage">[docs]</a><span class="k">class</span> <span class="nc">Stage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A stage object for maintaing data structure. This object is only created internally by the :class:`Simulator` class. The attributes of this class are directly called. The class does not provide accessor or setter methods, and should never be called externally.</span>
<span class="sd">    </span>
<span class="sd">    .. attribute:: Stage.do</span>
<span class="sd">        </span>
<span class="sd">        The stage function to be called during operation.</span>
<span class="sd">    </span>
<span class="sd">    .. attribute:: macro</span>
<span class="sd">        </span>
<span class="sd">        Boolean flag. Set to ``False`` if this stage has a callable ``do`` attribute.</span>
<span class="sd">        </span>
<span class="sd">    .. attribute:: exceptions</span>
<span class="sd">        </span>
<span class="sd">        A tuple of exceptions which should not cause this stage to fail.</span>
<span class="sd">    </span>
<span class="sd">    .. attribute:: name</span>
<span class="sd">        </span>
<span class="sd">        The calling, hashable name of this stage, stored here for return as a string value in messages.</span>
<span class="sd">        </span>
<span class="sd">    .. attribute:: description</span>
<span class="sd">        </span>
<span class="sd">        A human readable description of what this stage is doing, represeneted in the active voice and shown during operation.</span>
<span class="sd">        </span>
<span class="sd">    .. attribute:: deps</span>
<span class="sd">    </span>
<span class="sd">        List of all of the stages that this stage depends on.</span>
<span class="sd">        </span>
<span class="sd">    .. attribute:: reps</span>
<span class="sd">        </span>
<span class="sd">        List of all the stages that this stage could replace</span>
<span class="sd">        </span>
<span class="sd">    .. attribute:: optional</span>
<span class="sd">        </span>
<span class="sd">        A boolean flag. If it is set to true, the simulator will not raise a warning when this stage is skipped.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stage</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;a Stage&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">replaces</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Stage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">stage</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">description</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">exceptions</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reps</span> <span class="o">=</span> <span class="n">replaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="n">optional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stage.name"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Stage.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
    </div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">table_head</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Table head for profiling.&quot;&quot;&quot;</span>
        <span class="n">text</span>  <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&quot;|</span><span class="si">%(BLUE)s</span><span class="s">-----------------------</span><span class="si">%(NORMAL)s</span><span class="s">|</span><span class="si">%(BLUE)s</span><span class="s">--------</span><span class="si">%(NORMAL)s</span><span class="s">|</span><span class="si">%(BLUE)s</span><span class="s">---------------</span><span class="si">%(NORMAL)s</span><span class="s">|</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s">&quot;|         Stage         | Passed |     Time      |</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&quot;|</span><span class="si">%(BLUE)s</span><span class="s">-----------------------</span><span class="si">%(NORMAL)s</span><span class="s">|</span><span class="si">%(BLUE)s</span><span class="s">--------</span><span class="si">%(NORMAL)s</span><span class="s">|</span><span class="si">%(BLUE)s</span><span class="s">---------------</span><span class="si">%(NORMAL)s</span><span class="s">|&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>
      
    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">table_foot</span><span class="p">(</span><span class="n">total</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Table footer for profiling.&quot;&quot;&quot;</span>
        <span class="n">text</span>  <span class="o">=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&quot;|</span><span class="si">%(BLUE)s</span><span class="s">-----------------------</span><span class="si">%(NORMAL)s</span><span class="s"> Total Time: &quot;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="si">%(time)-9s</span><span class="s">&quot;</span><span class="o">+</span><span class="n">terminal</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(BLUE)s</span><span class="s">---</span><span class="si">%(NORMAL)s</span><span class="s">|&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">%</span> <span class="p">{</span><span class="s">&quot;time&quot;</span><span class="p">:</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">total</span><span class="p">))}</span>
        <span class="k">return</span> <span class="n">text</span>
        
    <span class="k">def</span> <span class="nf">table_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">total</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a profiling string table row.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ran</span><span class="p">,</span> <span class="s">&quot;Stage </span><span class="si">%s</span><span class="s"> didn&#39;t run&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">string</span> <span class="o">=</span>  <span class="s">u&quot;| </span><span class="si">%(stage)21s</span><span class="s"> | </span><span class="si">%(color)s%(result)6s%(normal)s</span><span class="s"> | </span><span class="si">%(timestr) 12s</span><span class="s"> |&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;stage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GREEN</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="k">else</span> <span class="n">terminal</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span>
                <span class="s">&quot;normal&quot;</span><span class="p">:</span> <span class="n">terminal</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span>
                <span class="s">&quot;result&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">),</span>
                <span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">durTime</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s">&quot;timestr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">% 12s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">keys</span><span class="p">[</span><span class="s">&quot;time&quot;</span><span class="p">]</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span><span class="p">[</span><span class="s">&quot;per&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">durTime</span> <span class="o">/</span> <span class="n">total</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="s">&quot;per&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">RED</span>
            <span class="k">elif</span> <span class="n">keys</span><span class="p">[</span><span class="s">&quot;per&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">BLUE</span>
            <span class="k">elif</span> <span class="n">keys</span><span class="p">[</span><span class="s">&quot;per&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GREEN</span>
            <span class="n">blen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="s">&quot;per&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">terminal</span><span class="o">.</span><span class="n">COLUMNS</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">75</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">blen</span> <span class="o">&gt;</span> <span class="n">terminal</span><span class="o">.</span><span class="n">COLUMNS</span> <span class="o">-</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">blen</span> <span class="o">=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">COLUMNS</span> <span class="o">-</span> <span class="mi">50</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="s">u&quot;█&quot;</span> <span class="o">*</span> <span class="n">blen</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">NORMAL</span>
            <span class="n">keys</span><span class="p">[</span><span class="s">&quot;timestr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(time)9s</span><span class="s"> </span><span class="si">%(per)2d%%</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">keys</span>
        <span class="k">return</span> <span class="n">string</span> <span class="o">%</span> <span class="n">keys</span>
        
    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string stage profile for this stage.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ran</span><span class="p">,</span> <span class="s">&quot;Stage </span><span class="si">%s</span><span class="s"> didn&#39;t run&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="s">&quot;Stage </span><span class="si">%(stage)s</span><span class="s"> </span><span class="si">%(result)s</span><span class="s"> in </span><span class="si">%(time).2f</span><span class="s">e&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s">&quot;stage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">&quot;result&quot;</span><span class="p">:</span> <span class="s">&quot;completed&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="k">else</span> <span class="s">&quot;failed&quot;</span><span class="p">,</span>
            <span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">durTime</span><span class="p">),</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the stage&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">durTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>
        
</div>
<div class="viewcode-block" id="Simulator"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator">[docs]</a><span class="k">class</span> <span class="nc">Simulator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Simulator, used for running large segements of code with detailed logging and progress checking. Simulators have a name, the `name` parameter can be left as is to use the name of the simulator&#39;s class (mostly useful if you subclassed it!). The `commandLine` parameter can be set to False to prevent the simulator collecting arguments from `sys.argv` for use. This allows you to programatically call the simulator with the :meth:`do` method.</span>
<span class="sd">    </span>
<span class="sd">    :param string name: Simulator name</span>
<span class="sd">    :param bool commandLine: Whether the simulator is run from the command line, or programatically.</span>
<span class="sd">    </span>
<span class="sd">    By default simulators are named for their class.&quot;&quot;&quot;</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Simulator&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;__class__.__name__&quot;</span><span class="p">,</span><span class="n">commandLine</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Simulator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Stages and dependents which have been attempted.        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Stages and dependents which have been walked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Stages and dependents which have been checked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Stages and dependents which have been executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aran</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">StructuredConfiguration</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s">&quot;Defaults.yaml&quot;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;__class__.__name__&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># The following are boolean state values for the simulator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caching</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandLine</span> <span class="o">=</span> <span class="n">commandLine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span> <span class="o">=</span> <span class="n">CacheManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="n">version</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s">u&quot;AstroObject: &quot;</span> <span class="o">+</span> <span class="n">__version__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">u&quot;: &quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s">u&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">u&quot;AstroObject: &quot;</span> <span class="o">+</span> <span class="n">__version__</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_initOptions</span><span class="p">()</span>
        
<div class="viewcode-block" id="Simulator._initOptions"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator._initOptions">[docs]</a>    <span class="k">def</span> <span class="nf">_initOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the command line options for this script. This function is automatically called on construction, and provides the following default command options which are already supported by the simulator:</span>
<span class="sd">        </span>
<span class="sd">        Command line options are:</span>
<span class="sd">        </span>
<span class="sd">        ================== =====================</span>
<span class="sd">        CLI Option         Description</span>
<span class="sd">        ================== =====================</span>
<span class="sd">        ``--version``      Display version information about this module</span>
<span class="sd">        ``--cf file.yaml`` Specify a configuration file</span>
<span class="sd">        ``--dry-run``      Print the stages this command would have run.</span>
<span class="sd">        ``--dump``         Write the current configuration to file</span>
<span class="sd">        ``--stages``       Print the stages that the command will execute, do not do anything</span>
<span class="sd">        ================== =====================</span>
<span class="sd">        </span>
<span class="sd">        Macros defined at this level are:</span>
<span class="sd">        </span>
<span class="sd">        ========= ==================================================</span>
<span class="sd">        Macro     Result</span>
<span class="sd">        ========= ==================================================</span>
<span class="sd">        ``*all``   Includes every stage</span>
<span class="sd">        ``*none``  Doesn&#39;t include any stages (technically redundant)</span>
<span class="sd">        ========= ==================================================</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">USAGE</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(command)s</span><span class="s"> </span><span class="si">%(basicOpts)s</span><span class="s"> </span><span class="si">%(subcommand)s</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">USAGEFMT</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;command&#39;</span> <span class="p">:</span> <span class="s">&quot;</span><span class="si">%(prog)s</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&#39;basicOpts&#39;</span><span class="p">:</span> <span class="s">&quot;[ options ][ configuration ]&quot;</span><span class="p">,</span> <span class="s">&#39;subcommand&#39;</span> <span class="p">:</span> <span class="s">&quot;{stages}&quot;</span> <span class="p">}</span>
        
        
        <span class="n">ShortHelp</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        Command Line Interface for </span><span class="si">%(name)s</span><span class="s">.</span>
<span class="s">        The simulator is set up in stages, which are listed below. </span>
<span class="s">        By default, the *all stage should run the important parts of the simulator.</span>
<span class="s">        </span>
<span class="s">        (*) Include      : To include a stage, use *stage. This will also run the dependents for that stage.</span>
<span class="s">        (-) Exclude      : To exclude a stage, use -stage. </span>
<span class="s">        (+) Include-only : To include a stage, but not the dependents of that stage, use +stage.</span>
<span class="s">        </span>
<span class="s">        To run the simulater, use </span>
<span class="s">        $ </span><span class="si">%(command)s</span><span class="s"> *all&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s">&#39;command&#39;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%(prog)s</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="p">}</span>
        <span class="n">LongHelp</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;The command line interface to </span><span class="si">%(name)s</span><span class="s"> normally takes a stage or stages as arguments. Each stage is specified on the command line prefixed by the *,+, or - characters. The * will run the stage and all dependents. The + will run solely that stage. The - will specifically exclude that stage (and so skip it&#39;s dependents).&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">ShortHelp</span><span class="p">,</span>
            <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span><span class="n">usage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">USAGE</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">USAGEFMT</span><span class="p">,</span><span class="n">prefix_chars</span><span class="o">=</span><span class="s">&quot;-+*&quot;</span><span class="p">)</span>
        
        <span class="c"># Parsers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&quot;Configuration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_stage_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;Single Use Stages&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neg_stage_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;Remove Stages&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc_stage_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;Stages&#39;</span><span class="p">)</span>
        
        <span class="c"># Add the basic controls for the script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--version&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;version&#39;</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        
        <span class="c"># Operational Controls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,{</span><span class="s">&#39;Debug&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;enable debugging messages and plots&quot;</span><span class="p">)</span>
        
        <span class="c"># Config Commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--p&#39;</span><span class="p">,</span><span class="s">&#39;--profile&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;profile&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--pre-configure&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s">&quot;{&#39;config&#39;:&#39;value&#39;}&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;preconfigure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--configure&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s">&quot;{&#39;config&#39;:&#39;value&#39;}&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Add configuration items in the form of python dictionaries&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;postconfig&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--cf&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;config&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;use the specified configuration file&quot;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s">&quot;file.yaml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--dry-run&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;dry_run&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Print the stages that the simulator wishes to run, without executing.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerFunction</span><span class="p">(</span><span class="s">&#39;--dump&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_dump_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerFunction</span><span class="p">(</span><span class="s">&#39;--stages&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_stages</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;List all of the stages initialized&quot;</span><span class="p">)</span>
        

        
        <span class="c"># Default Macro</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Run all stages&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Run all stages&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;none&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Run no stages&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Run no stages&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        </div>
<div class="viewcode-block" id="Simulator._default_macros"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator._default_macros">[docs]</a>    <span class="k">def</span> <span class="nf">_default_macros</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up the ``*all`` macro for this system, specifically, triggers the ``*all`` macro to run last.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;all&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;all&quot;</span><span class="p">]</span>

        
        
        </div>
<div class="viewcode-block" id="Simulator.registerStage"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.registerStage">[docs]</a>    <span class="k">def</span> <span class="nf">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stage</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">replaces</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a stage for operation with the simulator. The stage will then be available as a command line option, and will be operated with the simulator. Stages should be registered early in the operation of the simulator (preferably in the initialization, after the simulator class itself has initialized) so that the program is aware of the stages for running. </span>
<span class="sd">        </span>
<span class="sd">        :keyword function stage: The function to run for this stage. Should not take any arguments</span>
<span class="sd">        :keyword string name:  The command-line name of this stage (no spaces, `+`, `-`, or `*`)</span>
<span class="sd">        :keyword string description: A short description, which will be used by the logger when displaying information about the stage</span>
<span class="sd">        :keyword tuple exceptions: A tuple of exceptions which are acceptable results for this stage. These exceptions will be caught and logged, but will allow the simulator to continue. These exceptions will still raise errors in Debug mode.</span>
<span class="sd">        :keyword bool include: A boolean, Whether to include this stage in the `*all` macro or not.</span>
<span class="sd">        :keyword string help: Help text for the command line argument. A value of False excludes the help, None includes generic help.</span>
<span class="sd">        :keyword list dependencies: An ordered list of the stages which must run before this stage can run. Dependencies will be deep-searched.</span>
<span class="sd">        :keyword list replaces: A list of stages which can be replaced by this stage. This stage will now satisfy those dependencies.</span>
<span class="sd">        :keyword bool optional: A boolean about wheather this stage can be skipped. If so, warnings will not be raised when this stage is explicitly skipped (like ``-stage`` would do)</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    	Stages are called with either a ``*``, ``+`` or ``-`` character at the beginning. Their resepctive actions are shown below.</span>
<span class="sd">	</span>
<span class="sd">    	========= ============ ================================</span>
<span class="sd">    	Character  Action      Description</span>
<span class="sd">    	========= ============ ================================</span>
<span class="sd">    	``*``     Include      To include a stage, use ``*stage``. This will also run the dependents for that stage.</span>
<span class="sd">    	``-``     Exclude      To exclude a stage, use ``-stage``. This stage (and it&#39;s dependents) will be skipped.</span>
<span class="sd">    	``+``     Include-only To include a stage, but not the dependents of that stage, use ``+stage``.</span>
<span class="sd">    	========= ============ ================================</span>
<span class="sd">        </span>
<span class="sd">        To use a registered stage, and call all of its dependents, call ::</span>
<span class="sd">            </span>
<span class="sd">            $ Simulator *stage</span>
<span class="sd">            </span>
<span class="sd">        Registered stages can be explicity run from the command line by including::</span>
<span class="sd">            </span>
<span class="sd">            $ Simulator +stage</span>
<span class="sd">            </span>
<span class="sd">        And can be explicity excluded from the command line::</span>
<span class="sd">            </span>
<span class="sd">            $ Simulator -stage</span>
<span class="sd">            </span>
<span class="sd">        Where `+stage` will override `-stage` so::</span>
<span class="sd">            </span>
<span class="sd">            $ Simulator +test -test</span>
<span class="sd">            $ Simulator -test +test</span>
<span class="sd">            </span>
<span class="sd">        will both run the `test` stage.</span>
<span class="sd">        </span>
<span class="sd">        Stages cannot be added dynamically. Once the simulator starts running (i.e. processing stages) the order and settings are fixed. Attempting to adjsut the stages at this point will raise an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">starting</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Cannot add a new stage to the simulator, the simulation has already started!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot have duplicate stage named </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">exceptions</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="s">&#39;exceptions&#39;</span><span class="p">):</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">exceptions</span>
        <span class="k">elif</span> <span class="n">exceptions</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">dependencies</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="s">&#39;dependencies&#39;</span><span class="p">):</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">elif</span> <span class="n">dependencies</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid type for dependencies: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">dependencies</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">replaces</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="s">&#39;replaces&#39;</span><span class="p">):</span>
            <span class="n">replaces</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">replaces</span>  
        <span class="k">elif</span> <span class="n">replaces</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">replaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replaces</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid type for dependencies: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">replaces</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">description</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="s">&#39;description&#39;</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">description</span>
        <span class="k">elif</span> <span class="n">description</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">stage</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;Running </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">help</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="s">&#39;help&#39;</span><span class="p">):</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">help</span>
        <span class="k">elif</span> <span class="n">help</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span>
        <span class="k">elif</span> <span class="n">help</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;stage </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">include</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="s">&#39;include&#39;</span><span class="p">):</span>
            <span class="n">include</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">include</span>
        <span class="k">elif</span> <span class="n">include</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="bp">False</span>    
        
        <span class="n">stageObject</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="n">exceptions</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span><span class="n">replaces</span><span class="o">=</span><span class="n">replaces</span><span class="p">,</span><span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stageObject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_stage_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append_const&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;include&#39;</span><span class="p">,</span><span class="n">const</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neg_stage_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append_const&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;exclude&#39;</span><span class="p">,</span><span class="n">const</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc_stage_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append_const&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;macro&#39;</span><span class="p">,</span><span class="n">const</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="s">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">deps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        </div>
<div class="viewcode-block" id="Simulator.registerFunction"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.registerFunction">[docs]</a>    <span class="k">def</span> <span class="nf">registerFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">argument</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">post</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a function to run using a flag.</span>
<span class="sd">        </span>
<span class="sd">        :param string argument: The calling argument, e.g. ``--hello-world``</span>
<span class="sd">        :param function function: The function to be run.</span>
<span class="sd">        :keyword bool post: Whether to run the function before or after configuration of the simulator.</span>
<span class="sd">        </span>
<span class="sd">        Functions registered with ``post=False`` will be run before the simulator is configured from a file. As such, changes they make can be easily re-adjusted by the user. Functions registered with ``post=True`` (the default) will run after configuration, but before any stages run. They can be used to inspect or adjust configuration variables or other globals.</span>
<span class="sd">        </span>
<span class="sd">        Other keyword arguments are passed to :meth:`ArgumentParser.add_argument`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">starting</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigureError</span><span class="p">(</span><span class="s">&quot;Cannot add macro after simulator has started!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s">&quot;help&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">post</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">=</span><span class="s">&#39;postfunc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">=</span><span class="s">&#39;prefunc&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append_const&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;postfunc&#39;</span><span class="p">,</span><span class="n">const</span><span class="o">=</span><span class="n">function</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        </div>
<div class="viewcode-block" id="Simulator.registerConfigOpts"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.registerConfigOpts">[docs]</a>    <span class="k">def</span> <span class="nf">registerConfigOpts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">argument</span><span class="p">,</span><span class="n">configuration</span><span class="p">,</span><span class="n">preconfig</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers a bulk configuration option which will be provided with the USAGE statement. This configuration option can easily override normal configuration settings. Configuration provided here will override programmatically specified configuration options. It will not override configuration provided by the configuration file. These configuration options are meant to provide alterantive *defaults*, not alternative configurations.</span>
<span class="sd">        </span>
<span class="sd">        :param string argument: The command line argument (e.g. ``-D``)</span>
<span class="sd">        :param dict configuration: The configuration dictionary to be merged with the master configuration.</span>
<span class="sd">        :keyword bool preconfig: Applies these adjustments before loading the configuration file.</span>
<span class="sd">        </span>
<span class="sd">        Other keyword arguments are passed to :meth:`ArgumentParser.add_argument`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">starting</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigureError</span><span class="p">(</span><span class="s">&quot;Cannot add macro after simulator has started!&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s">&quot;help&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">preconfig</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="s">&#39;preconfig&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="s">&#39;postconifg&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">argument</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;append_const&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span><span class="n">const</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        </div>
<div class="viewcode-block" id="Simulator._configure"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator._configure">[docs]</a>    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">configFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">configuration</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure this object. Configuration happens first from passed dictionaries (`configuration` variable) and then from files. The result is that configuration will use the values from files in place of values from passed in dictionaries. Running this function twice requires re-setting the `self.configured`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Cannot configure the simulator, the simulation has already started!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> appears to be already configured&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="c"># Configure from Variable</span>
        <span class="k">if</span> <span class="n">configuration</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Updated Configuration from variable&quot;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">|=</span> <span class="bp">True</span>
        <span class="c"># Configure from File</span>
        <span class="k">if</span> <span class="n">configFile</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Updated Configuration from file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">configFile</span><span class="p">)</span>                        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Updated Configuration from default file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Configurations&quot;</span><span class="p">][</span><span class="s">&quot;This&quot;</span><span class="p">])</span>            
        
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s">&quot;No configuration provided or accessed. Using defaults.&quot;</span><span class="p">)</span>
        
        <span class="c"># Start Logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c"># Write Configuration to Partials Directory</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Partials&quot;</span><span class="p">]):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_filename</span><span class="p">(</span><span class="s">&quot;Partials&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.config.yaml&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Configuration from </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">stream</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> 
    </div>
    <span class="k">def</span> <span class="nf">_dir_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">directory</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a directory filename.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%(directory)s</span><span class="s">/</span><span class="si">%(filename)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s">&quot;directory&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="n">directory</span><span class="p">]</span> <span class="p">,</span> <span class="s">&quot;filename&quot;</span> <span class="p">:</span> <span class="n">filename</span> <span class="p">}</span>
        
<div class="viewcode-block" id="Simulator._parseArguments"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator._parseArguments">[docs]</a>    <span class="k">def</span> <span class="nf">_parseArguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse arguments. Argumetns can be passed into this function like they would be passed to the command line. These arguments will only be parsed when the system is not in `commandLine` mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandLine</span><span class="p">:</span>
            <span class="n">Namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">Namespace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;Parsed command line arguments&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">Namespace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;Parsed default line arguments&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Skipping argument parsing&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Simulator._preConfiguration"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator._preConfiguration">[docs]</a>    <span class="k">def</span> <span class="nf">_preConfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies arguments before configuration. Only argument applied is the name of the configuration file, allowing the command line to change the configuration file name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;config&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;config&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Configurations&quot;</span><span class="p">][</span><span class="s">&quot;This&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;config&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&quot;preconfig&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;preconfig&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">preconfig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;preconfig&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preconfig</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="n">preconfig</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">preconfig</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">preconfig</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;prefunc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;prefunc&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;prefunc&quot;</span><span class="p">]:</span>
                <span class="n">f</span><span class="p">()</span>
        
            </div>
<div class="viewcode-block" id="Simulator._postConfiguration"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator._postConfiguration">[docs]</a>    <span class="k">def</span> <span class="nf">_postConfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply arguments after configuration. The arguments applied here flesh out macros, and copy data from the configuration system into the operations system.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;exclude&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;exclude&quot;</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;exclude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s">&quot;include&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;include&quot;</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;include&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s">&quot;macro&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s">&quot;postconfig&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;postconfig&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">preconfig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;postconfig&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preconfig</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="n">preconfig</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">preconfig</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">preconfig</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s">&quot;postfunc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;postfunc&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;postfunc&quot;</span><span class="p">]:</span>
                <span class="n">f</span><span class="p">()</span>
        
        </div>
    <span class="k">def</span> <span class="nf">_list_stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List stages and exit&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Stages:</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%(command)-20s</span><span class="s"> : </span><span class="si">%(desc)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;command&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;desc&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">description</span><span class="p">}</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump the configuration to a file&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Configurations&quot;</span><span class="p">][</span><span class="s">&quot;This&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;.yaml&quot;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.dump.yaml&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Configuration from </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">extract</span><span class="p">(),</span><span class="n">stream</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> 
        
                
<div class="viewcode-block" id="Simulator.startup"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.startup">[docs]</a>    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start up the simulation. This function handles the configuration of the system, and prepares for any calls made to :meth:`do`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_macros</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parseArguments</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preConfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">configFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Configurations&quot;</span><span class="p">][</span><span class="s">&quot;This&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postConfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting</span> <span class="o">=</span> <span class="bp">False</span>
        
        
        </div>
<div class="viewcode-block" id="Simulator.run"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the actual simulator. This command handles simulators which can be run from the command line. Calling :meth:`run` will run all of the stages specified on the command line. If you do not want this effect, use :meth:`startup` to prepare the simulator, and :meth:`do` to run the actual simulator. Calling :meth:`exit` at the end will allow the simulator to close out and perform any output tasks, but will also end the current python session.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="Simulator.do"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.do">[docs]</a>    <span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">stages</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the simulator.</span>
<span class="sd">        </span>
<span class="sd">        :arguments stages: Stages to be run as macros.</span>
<span class="sd">        </span>
<span class="sd">        This command can be used to run specific stages and their dependents. The control is far less flow control than the command-line interface (there is currently no argument interface to inclusion and exclusion lists, ``+`` and ``-``.), but can be used to call single macros in simulators froms scripts. In these cases, it is often beneficial to set up your own macro (calling :func:`registerStage` with ``None`` as the stage action) to wrap the actions you want taken in each phase.</span>
<span class="sd">        </span>
<span class="sd">        It is possible to stop execution in the middle of this function. Simply set the simulator&#39;s ``paused`` variable to ``True`` and the simulator will remain in a state where you are free to call :meth:`do` again.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Simulator is already running!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pasued</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stages</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stages</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Default&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Default&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No stages triggered to run!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inorder</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;macro&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;include&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="n">deps</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_profile</span><span class="p">()</span>
            <span class="k">raise</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;dry_run&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Stages done:</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%(command)-20s</span><span class="s"> : </span><span class="si">%(desc)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;command&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;desc&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">description</span><span class="p">}</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;profile&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_profile</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">show_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the profile of the simulation&quot;&quot;&quot;</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">.</span><span class="n">durTime</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aran</span><span class="p">])</span>
        
        <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Simulation profile:</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="n">Stage</span><span class="o">.</span><span class="n">table_head</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aran</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">.</span><span class="n">table_row</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            
        <span class="n">text</span> <span class="o">+=</span> <span class="n">Stage</span><span class="o">.</span><span class="n">table_foot</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            
<div class="viewcode-block" id="Simulator.execute"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stage</span><span class="p">,</span><span class="n">deps</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually exectue a particular stage. This function can be called to execute individual stages, either with or without dependencies. As such, it gives finer granularity than :func:`do`.</span>
<span class="sd">        </span>
<span class="sd">        :param string stage: The stage name to be exectued.</span>
<span class="sd">        :param bool deps: Whether to run all dependencies.</span>
<span class="sd">        </span>
<span class="sd">        This method handles exceptions from the called stages, including keyboard interrupts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
            
        <span class="k">if</span> <span class="n">stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Stage </span><span class="si">%s</span><span class="s"> does not exist.&quot;</span> <span class="o">%</span> <span class="n">stage</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">use</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;exclude&quot;</span><span class="p">]:</span>
            <span class="n">use</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;include&quot;</span><span class="p">]:</span>
            <span class="n">use</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">use</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">use</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">.</span><span class="n">reps</span>
         
        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            
            <span class="k">for</span> <span class="n">dependent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dependent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dependent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">dependent</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dependent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">dependent</span><span class="p">]</span><span class="o">.</span><span class="n">optional</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Stage </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> requested by </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> but skipped&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dependent</span><span class="p">,</span><span class="n">stage</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Stage </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> required by </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> but failed to complete.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dependent</span><span class="p">,</span><span class="n">stage</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Explicity skipping dependents&quot;</span><span class="p">)</span>
        
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">macro</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;dry_run&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">reps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stage</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">use</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Keyboard Interrupt during </span><span class="si">%(stage)s</span><span class="s">... ending simulator.&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;stage&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Last completed stage: </span><span class="si">%(stage)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;stage&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="o">.</span><span class="n">pop</span><span class="p">()})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Stages completed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">s</span><span class="o">.</span><span class="n">exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Debug&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&quot;Error </span><span class="si">%(name)s</span><span class="s"> in stage </span><span class="si">%(stage)s</span><span class="s">:</span><span class="si">%(desc)s</span><span class="s">. Stage indicated that this error was not critical&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;desc&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">description</span><span class="p">,</span><span class="s">&#39;stage&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&quot;Error: </span><span class="si">%(msg)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;msg&#39;</span><span class="p">:</span><span class="n">e</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Debug&quot;</span><span class="p">]:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">u&quot;Error </span><span class="si">%(name)s</span><span class="s"> in stage </span><span class="si">%(stage)s</span><span class="s">:</span><span class="si">%(desc)s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;desc&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">description</span><span class="p">,</span><span class="s">&#39;stage&#39;</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">u&quot;Error: </span><span class="si">%(msg)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;msg&#39;</span><span class="p">:</span><span class="n">e</span><span class="p">})</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u&quot;Completed </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">reps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stage</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aran</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stage</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u&quot;Finished </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">use</span>
        </div>
<div class="viewcode-block" id="Simulator.exit"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.exit">[docs]</a>    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function exist the current python instance with the requested code. Before exiting, a message is printed.</span>
<span class="sd">        </span>
<span class="sd">        :param int code: exit code</span>
<span class="sd">        :param string msg: exit message&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Simulator </span><span class="si">%s</span><span class="s"> Finished&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Simulator.collect"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">matching</span><span class="o">=</span><span class="s">r&#39;^(?!\_)&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect class methods for inclusion as simulator stages. Instance methods are collected if they do not belong to the parent :class:`Simulator` class (i.e. this method, and others like :meth:`registerStage` will not be collected.). Registered stages will default to having no dependents, to be named similar to thier own methods (``collected_stage`` becomes ``*collected-stage`` on the command line) and will use thier doc-string as the stage description. The way in which these stages are collected can be adjusted using the decorators provided in this module.</span>
<span class="sd">        </span>
<span class="sd">        To define a method as a stage with a dependent, help string, and by default inclusion, use::</span>
<span class="sd">            </span>
<span class="sd">            @collect</span>
<span class="sd">            @include</span>
<span class="sd">            @description(&quot;Doing something&quot;)</span>
<span class="sd">            @help(&quot;Do something&quot;)</span>
<span class="sd">            @depends(&quot;other-stage&quot;)</span>
<span class="sd">            @replaces(&quot;missing-stage&quot;)</span>
<span class="sd">            def stagename(self):</span>
<span class="sd">                pass</span>
<span class="sd">        </span>
<span class="sd">        This method does not do any logging. It should be called before the :meth:`run` method for the simulator is called.</span>
<span class="sd">        </span>
<span class="sd">        Private methods are not included using the default matching string ``r&#39;^(?!\_)&#39;``. This string excludes any method beginning with an underscore. Alternative method name matching strings can be provided by the user.</span>
<span class="sd">        </span>
<span class="sd">        :param string matching: Regular expression used for matching method names.</span>
<span class="sd">        :param kwargs: Keyword arguments passed to the :meth:`registerStage` function.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">genericList</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Simulator</span><span class="p">)</span>
        <span class="n">currentList</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">stageList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">currentList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">methodname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">genericList</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">methodname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">matching</span><span class="p">,</span><span class="n">methodname</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="s">&#39;collect&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span> <span class="p">):</span>
                    <span class="n">stageList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
                    
        <span class="n">stageList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">func_lineno</span><span class="p">)</span>
        <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">stageList</span> <span class="p">]</span>
    
    </div>
    <span class="k">def</span> <span class="nf">_start_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a progress bar object of a specified color in the standard format.&quot;&quot;&quot;</span>
        <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">Percentage</span><span class="p">(),</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">ColorBar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">),</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="n">ETA</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">,</span><span class="n">maxval</span><span class="o">=</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span>
        
    <span class="k">def</span> <span class="nf">_end_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End the progressbar object&#39;s operation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="p">[],</span><span class="n">idfun</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map a function over a given collection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exceptions</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="ne">Exception</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="ow">and</span> <span class="n">color</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_progress_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">collection</span><span class="p">),</span><span class="n">color</span><span class="p">)</span>
            <span class="n">showBar</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">showBar</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_map</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">idfun</span><span class="p">,</span><span class="n">showBar</span><span class="p">),</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>       
            <span class="k">if</span> <span class="n">showBar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_end_progress_bar</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Trapped </span><span class="si">%d</span><span class="s"> errors&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Error </span><span class="si">%s</span><span class="s"> caught&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
    
<div class="viewcode-block" id="Simulator.map_over_collection"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.Simulator.map_over_collection">[docs]</a>    <span class="k">def</span> <span class="nf">map_over_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">idfun</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="p">[],</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for map_over_collection&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">idfun</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">_collection_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">idfun</span><span class="p">,</span><span class="n">showBar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps something over a bunch of lenslets&quot;&quot;&quot;</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">idfun</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">showBar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&quot;Caught </span><span class="si">%s</span><span class="s"> in </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">identity</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">e</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Debug&quot;</span><span class="p">]:</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">showBar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">+=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="optional"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.optional">[docs]</a><span class="k">def</span> <span class="nf">optional</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes this object optional&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optional</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">optional</span>
        <span class="n">func</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="n">optional</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
    </div>
<div class="viewcode-block" id="description"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.description">[docs]</a><span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gives this object a description&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
    
</div>
<div class="viewcode-block" id="include"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.include">[docs]</a><span class="k">def</span> <span class="nf">include</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Commands this object to be included&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">include</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">include</span>
        <span class="n">func</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
</div>
<div class="viewcode-block" id="replaces"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.replaces">[docs]</a><span class="k">def</span> <span class="nf">replaces</span><span class="p">(</span><span class="o">*</span><span class="n">replaces</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Registers replacements for this stage&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">replaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">replaces</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
</div>
<div class="viewcode-block" id="help"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.help">[docs]</a><span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="n">help</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Registers a help string for this function&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="n">help</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
</div>
<div class="viewcode-block" id="depends"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.depends">[docs]</a><span class="k">def</span> <span class="nf">depends</span><span class="p">(</span><span class="o">*</span><span class="n">dependencies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Registers dependencies for this function&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
</div>
<span class="k">def</span> <span class="nf">excepts</span><span class="p">(</span><span class="o">*</span><span class="n">exceptions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Registers dependencies for this function&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exceptions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>

<div class="viewcode-block" id="collect"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.collect">[docs]</a><span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">collect</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Include stage explicitly in collection&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">collect</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">collect</span>
        <span class="n">func</span><span class="o">.</span><span class="n">collect</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">collect</span> <span class="o">=</span> <span class="n">collect</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
    
</div>
<div class="viewcode-block" id="ignore"><a class="viewcode-back" href="../../AstroSimulator.html#AstroObject.AstroSimulator.ignore">[docs]</a><span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="n">ignore</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ignore stage explicitly in collection&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">ignore</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">ignore</span>
        <span class="n">func</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="n">ignore</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>
    
</div>
<span class="k">def</span> <span class="nf">on_instance_collection</span><span class="p">(</span><span class="n">get_collection</span><span class="p">,</span><span class="n">idfun</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for acting a specific method over a collection&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">def</span> <span class="nf">newfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_over_collection</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">idfun</span><span class="p">,</span><span class="n">get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">newfunc</span> <span class="o">=</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span><span class="n">newfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newfunc</span>
    <span class="k">return</span> <span class="n">decorate</span>
    
<span class="k">def</span> <span class="nf">on_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span><span class="n">idfun</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for acting a specific method over a collection&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">def</span> <span class="nf">newfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_over_collection</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">idfun</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">newfunc</span> <span class="o">=</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span><span class="n">newfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newfunc</span>
    <span class="k">return</span> <span class="n">decorate</span>
    
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">AstroObject 0.5-b1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Alexander Rudy.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>